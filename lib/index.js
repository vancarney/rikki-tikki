// Generated by CoffeeScript 1.10.0
var APIOptions, ApiHero, Document, EventEmitter, ModuleManager, SyncInitializer, Util, _, e, error, fs, path,
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

_ = require('lodash')._;

EventEmitter = require('events').EventEmitter;

fs = require('fs');

path = require('path');

Util = require('./classes/utils');

APIOptions = require('./classes/config/APIOptions');

global.logger = console;

global.helpers = {};

ApiHero = (function(superClass) {
  extend(ApiHero, superClass);

  function ApiHero(app, options) {
    var cnfPath, config, e, error, shouldManageRoutes;
    if (options == null) {
      options = {};
    }
    if (!((app != null) && typeof app === 'function')) {
      throw 'argument[0] must be App reference';
    }
    if (global.app_root == null) {
      global.app_root = process.cwd();
    }
    _.extend(app.prototype, EventEmitter);
    try {
      if (fs.statSync("" + (cnfPath = path.join(app_root, 'apihero.json')))) {
        config = require(cnfPath);
      }
    } catch (error) {
      e = error;
      config = {
        moduleOptions: {}
      };
    }
    this.options = _.extend({}, config, options);
    module.exports.getApp = (function(_this) {
      return function() {
        return app;
      };
    })(this);
    _.each(this.options, (function(_this) {
      return function(v, k) {
        return APIOptions.set(k, v);
      };
    })(this));
    ApiHero.Util.File.ensureDirExists(APIOptions.get('data_path'));
    ApiHero.Util.File.ensureDirExists(APIOptions.get('trees_path'));
    this.router = ApiHero.Router.getInstance();
    this.router.addRoute("/api-client/__schema__.json", 'get', (function(_this) {
      return function(req, res) {
        var ref;
        return (ref = _this.router.getAdapter()) != null ? ref.responseHandler(res, {
          status: 200,
          content: ApiHero.SchemaManager.getInstance().toJSON(Util.Env.isDevelopment())
        }) : void 0;
      };
    })(this));
    this.router.addRoute("/api-client/client(\.js)?", 'get', (function(_this) {
      return function(req, res) {
        var ref;
        return (ref = _this.router.getAdapter()) != null ? ref.responseHandler(res, {
          status: 200,
          content: _this.router.getClient()
        }, {
          'Content-Type': 'text/javascript'
        }) : void 0;
      };
    })(this));
    app.set('legacyExplorer', false);
    app.ApiHero = ApiHero;
    shouldManageRoutes = (function(_this) {
      return function() {
        if (Util.Env.isProduction()) {
          return false;
        }
        return APIOptions.get("monitor_requests");
      };
    })(this);
    app.once('ahero-initialized', (function(_this) {
      return function() {
        if (shouldManageRoutes()) {
          return SyncInitializer.init(ApiHero);
        }
      };
    })(this));
    ApiHero.DSManager.getInstance().initialize((function(_this) {
      return function(e, ok) {
        var moduleManager;
        if (e != null) {
          console.log(e);
          process.exit(1);
        }
        moduleManager = new ModuleManager(app, APIOptions.get("moduleOptions") || {});
        app.ApiHero.listModules = function() {
          return moduleManager.listModules();
        };
        app.ApiHero.getModuleConfigs = function() {
          return moduleManager.getModuleConfigs();
        };
        app.ApiHero.getModule = function(name) {
          return moduleManager.getModule(name);
        };
        app.emit('ahero-initialized');
        return moduleManager.load(function(e, modules) {
          if (e != null) {
            throw e;
            process.exit(1);
          }
          return app.emit('ahero-ready');
        });
      };
    })(this));
  }

  return ApiHero;

})(EventEmitter);

ApiHero.init = function(app, options) {
  return new ApiHero(app, options);
};

ApiHero.loadedModules = null;

ApiHero.proxyEvent = function(name, delegator) {
  if (!delegator) {
    throw "ApiHero.proxyEvent: delegator not defined";
  }
  if (typeof delegator.on !== 'function') {
    throw "ApiHero.proxyEvent: delegator.on is not a function";
  }
  return typeof delegator.on === "function" ? delegator.on(name, (function(_this) {
    return function(evt, data) {
      return module.exports.getApp().emit(name, evt, data);
    };
  })(this)) : void 0;
};

ApiHero.addRoute = (function(_this) {
  return function(path, operation, handler) {
    var router;
    if ((router = ApiHero.Router.getInstance()) == null) {
      throw new Error('Adapter is not defined');
    }
    return router.addRoute(path, operation, handler);
  };
})(this);

try {
  require('rikki-tikki-client');
} catch (error) {
  e = error;
  throw new Error("rikki-tikki-client was not found. Try 'npm install rikki-tikki-client'");
  process.exit(1);
}

_.extend(ApiHero, require('./classes/router'));

ApiHero.Util = require('./classes/utils');

ApiHero.SyncService = require('./classes/services/SyncService');

ApiHero.SyncInstance = require('./classes/services/SyncInstance');

ApiHero.SyncOperation = require('./classes/services/SyncOperation');

Document = require('./classes/collections/Document');

ApiHero.DSManager = require('./classes/datasource/DataSourceManager');

SyncInitializer = require('./classes/services/SyncInitializer');

ModuleManager = require('./classes/module/ModuleManager');

ApiHero.AbstractMonitor = require('./classes/base_class/AbstractMonitor');

ApiHero.AbstractLoader = require('./classes/base_class/AbstractLoader');

ApiHero.createSyncInstance = (function(_this) {
  return function(name, clazz) {
    return ApiHero.SyncService.getInstance().registerSyncInstance(name, new ApiHero.SyncService.SyncInstance(name, clazz));
  };
})(this);

ApiHero.destroySyncInstance = (function(_this) {
  return function(name) {
    return ApiHero.SyncService.getInstance().removeSyncInstance(name);
  };
})(this);

ApiHero.model = function(name, schema) {
  var _this, model, type;
  if (schema == null) {
    schema = {};
  }
  if (!name) {
    throw "name is required for model";
  }
  if ((type = typeof name) !== 'string') {
    throw "name expected to be String type was '" + type + "'";
  }
  _this = this;
  model = function model(data, opts) { if (!(this instanceof ApiHero.model)) return _.extend(_this, new Document( data, opts )); };
  model.modelName = name;
  model.schema = schema;
  model.toClientSchema = function() {
    var ClientSchema;
    ClientSchema = require('./classes/schema/ClientSchema');
    return new ClientSchema(this.modelName, this.schema);
  };
  model.toAPISchema = function() {
    var APISchema;
    APISchema = require('./classes/schema/APISchema');
    return new APISchema(this.modelName, this.schema);
  };
  return model;
};

module.exports = ApiHero;
